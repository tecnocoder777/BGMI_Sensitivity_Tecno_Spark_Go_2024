<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Local-First ERP</title>

    <!-- UI LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- NOTIFICATION LIBRARY -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#3B82F6', 600: '#2563EB', 900: '#1E3A8A' },
                        surface: '#F8FAFC'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        /**
         * ------------------------------------------------------------------
         * 1️⃣ VIRTUAL BACKEND SYSTEM (Simulating Node.js + DB)
         * ------------------------------------------------------------------
         * This section effectively replaces Express.js and MongoDB
         */

        // --- IndexedDB Wrapper for Large File Storage ---
        const FileSystem = {
            dbName: 'EnterpriseFileStore',
            storeName: 'uploads',
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (e) => {
                        e.target.result.createObjectStore(this.storeName);
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e);
                });
            },

            async saveFile(file) {
                const db = await this.init();
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    tx.objectStore(this.storeName).put(file, fileId);
                    tx.oncomplete = () => resolve(fileId);
                    tx.onerror = () => reject('File save failed');
                });
            },

            async getFileUrl(fileId) {
                const db = await this.init();
                return new Promise((resolve) => {
                    const tx = db.transaction(this.storeName, 'readonly');
                    const req = tx.objectStore(this.storeName).get(fileId);
                    req.onsuccess = () => {
                        if (req.result) {
                            resolve(URL.createObjectURL(req.result));
                        } else {
                            resolve(null);
                        }
                    };
                });
            }
        };

        // --- JSON Database Engine (LocalStorage) ---
        class Database {
            constructor() {
                this.tables = ['users', 'items'];
                this.init();
            }

            init() {
                // Initialize default Admin if not exists
                const users = this.read('users');
                if (users.length === 0) {
                    this.write('users', [{
                        id: 'admin_001',
                        email: 'admin@admin.com',
                        password: 'admin', // In real app, hash this!
                        role: 'admin',
                        name: 'System Administrator',
                        createdAt: new Date().toISOString()
                    }]);
                }
                if (!localStorage.getItem('items')) this.write('items', []);
            }

            read(table) {
                return JSON.parse(localStorage.getItem(table) || '[]');
            }

            write(table, data) {
                localStorage.setItem(table, JSON.stringify(data));
            }

            insert(table, doc) {
                const data = this.read(table);
                const newDoc = { ...doc, id: doc.id || `id_${Date.now()}`, createdAt: new Date().toISOString() };
                data.push(newDoc);
                this.write(table, data);
                return newDoc;
            }

            update(table, id, updates) {
                const data = this.read(table);
                const idx = data.findIndex(d => d.id === id);
                if (idx === -1) throw new Error('Document not found');
                data[idx] = { ...data[idx], ...updates };
                this.write(table, data);
                return data[idx];
            }

            delete(table, id) {
                const data = this.read(table);
                const newData = data.filter(d => d.id !== id);
                this.write(table, newData);
            }
        }

        const db = new Database();

        // --- REST API Simulator ---
        const Server = {
            // Emulates Network Latency
            async request(method, endpoint, body = null, token = null) {
                console.log(`[SERVER LOG] ${method} ${endpoint}`, body || '');
                await new Promise(r => setTimeout(r, 600)); // 600ms latency

                try {
                    // --- AUTH ROUTES ---
                    if (endpoint === '/api/login') {
                        const users = db.read('users');
                        const user = users.find(u => u.email === body.email && u.password === body.password);
                        if (!user) throw new Error('Invalid credentials');
                        // Mock JWT Token
                        const fakeToken = btoa(JSON.stringify({ id: user.id, role: user.role }));
                        return { token: fakeToken, user };
                    }

                    if (endpoint === '/api/signup') {
                        const users = db.read('users');
                        if (users.find(u => u.email === body.email)) throw new Error('Email already exists');
                        const newUser = db.insert('users', { 
                            email: body.email, 
                            password: body.password, 
                            role: 'user', 
                            name: body.email.split('@')[0] 
                        });
                        return { message: 'User created' };
                    }

                    // --- MIDDLEWARE: VERIFY TOKEN ---
                    if (!token) throw new Error('Unauthorized');

                    // --- ITEM ROUTES ---
                    if (endpoint === '/api/items') {
                        if (method === 'GET') {
                            const items = db.read('items');
                            // Populate file URLs
                            const populated = await Promise.all(items.map(async item => ({
                                ...item,
                                url: item.fileId ? await FileSystem.getFileUrl(item.fileId) : null
                            })));
                            return populated.reverse();
                        }
                        
                        if (method === 'POST') {
                            return db.insert('items', body);
                        }
                    }

                    if (endpoint.startsWith('/api/items/')) {
                        const id = endpoint.split('/').pop();
                        if (method === 'DELETE') return db.delete('items', id);
                    }

                    if (endpoint === '/api/upload') {
                        // Handle File Upload to IndexedDB
                        const fileId = await FileSystem.saveFile(body.file);
                        return { fileId };
                    }

                    throw new Error('404 Not Found');

                } catch (err) {
                    throw { message: err.message || 'Server Error' };
                }
            }
        };

        // ------------------------------------------------------------------
        // 2️⃣ FRONTEND LOGIC (React)
        // ------------------------------------------------------------------

        const { useState, useEffect, useContext, createContext } = React;

        // --- Auth Context ---
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('auth_token'));

            useEffect(() => {
                if (token) {
                    // Restore session from token (decoding fake JWT)
                    try {
                        const payload = JSON.parse(atob(token));
                        const dbUsers = db.read('users');
                        const found = dbUsers.find(u => u.id === payload.id);
                        if (found) setUser(found);
                    } catch (e) {
                        logout();
                    }
                }
            }, [token]);

            const login = async (email, password) => {
                const res = await Server.request('POST', '/api/login', { email, password });
                localStorage.setItem('auth_token', res.token);
                setToken(res.token);
                setUser(res.user);
            };

            const logout = () => {
                localStorage.removeItem('auth_token');
                setToken(null);
                setUser(null);
            };

            return (
                <AuthContext.Provider value={{ user, token, login, logout }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // --- Components ---

        const Spinner = () => <i className="fas fa-circle-notch fa-spin text-brand-600"></i>;

        const Navbar = () => {
            const { user, logout } = useContext(AuthContext);
            return (
                <nav className="bg-brand-900 text-white shadow-lg sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center space-x-2">
                            <i className="fas fa-layer-group text-xl text-blue-400"></i>
                            <span className="font-bold text-lg tracking-wide">Enterprise<span className="text-blue-400">Node</span></span>
                        </div>
                        <div className="flex items-center space-x-6">
                            <div className="text-sm hidden md:block">
                                <span className="opacity-75">Welcome, </span>
                                <span className="font-semibold">{user.name}</span>
                                <span className={`ml-2 text-xs px-2 py-0.5 rounded ${user.role === 'admin' ? 'bg-red-500' : 'bg-green-500'}`}>
                                    {user.role.toUpperCase()}
                                </span>
                            </div>
                            <button onClick={logout} className="text-red-300 hover:text-white transition">
                                <i className="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            );
        };

        const Dashboard = () => {
            const { user, token } = useContext(AuthContext);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(false);
            const [uploading, setUploading] = useState(false);
            
            // Form State
            const [title, setTitle] = useState('');
            const [file, setFile] = useState(null);

            useEffect(() => {
                fetchItems();
            }, []);

            const fetchItems = async () => {
                setLoading(true);
                try {
                    const data = await Server.request('GET', '/api/items', null, token);
                    setItems(data);
                } catch (err) {
                    Swal.fire('Error', err.message, 'error');
                }
                setLoading(false);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setUploading(true);
                try {
                    let fileId = null;
                    let fileType = 'text';

                    if (file) {
                        const uploadRes = await Server.request('POST', '/api/upload', { file }, token);
                        fileId = uploadRes.fileId;
                        fileType = file.type.startsWith('video') ? 'video' : 'image';
                    }

                    await Server.request('POST', '/api/items', {
                        title,
                        fileId,
                        fileType,
                        userId: user.id,
                        author: user.name
                    }, token);

                    Swal.fire('Success', 'Item published successfully', 'success');
                    setTitle('');
                    setFile(null);
                    fetchItems();
                } catch (err) {
                    Swal.fire('Failed', err.message, 'error');
                }
                setUploading(false);
            };

            const handleDelete = async (id) => {
                if(!confirm('Are you sure you want to delete this?')) return;
                try {
                    await Server.request('DELETE', `/api/items/${id}`, null, token);
                    fetchItems();
                } catch (err) {
                    Swal.fire('Error', err.message, 'error');
                }
            };

            return (
                <div className="min-h-screen bg-surface">
                    <Navbar />
                    
                    <div className="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        {/* LEFT COLUMN: UPLOAD FORM */}
                        <div className="lg:col-span-1">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-24">
                                <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                                    <i className="fas fa-cloud-upload-alt mr-2 text-brand-600"></i>
                                    Create Post
                                </h3>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-1">Title</label>
                                        <input 
                                            type="text" 
                                            value={title}
                                            onChange={(e) => setTitle(e.target.value)}
                                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition"
                                            placeholder="Project name or title..."
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-1">Attach Media</label>
                                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                            <input 
                                                type="file" 
                                                onChange={(e) => setFile(e.target.files[0])}
                                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                                accept="image/*,video/*"
                                            />
                                            {file ? (
                                                <div className="text-green-600 font-medium">
                                                    <i className="fas fa-check-circle mb-1"></i><br/>
                                                    {file.name}
                                                </div>
                                            ) : (
                                                <div className="text-gray-400">
                                                    <i className="fas fa-image text-2xl mb-2"></i><br/>
                                                    <span className="text-sm">Click to upload Image/Video</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <button 
                                        type="submit" 
                                        disabled={uploading}
                                        className={`w-full py-2.5 rounded-lg text-white font-medium shadow-md transition transform active:scale-95 ${uploading ? 'bg-gray-400' : 'bg-brand-600 hover:bg-brand-500'}`}
                                    >
                                        {uploading ? <span><Spinner/> Uploading...</span> : 'Publish Content'}
                                    </button>
                                </form>
                            </div>

                            {/* API DOCUMENTATION WIDGET */}
                            <div className="mt-6 bg-slate-800 text-gray-300 rounded-xl p-4 text-xs font-mono">
                                <div className="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                                    <span className="font-bold text-white">API ENDPOINTS</span>
                                    <span className="bg-green-500 text-black px-1 rounded">v1.0</span>
                                </div>
                                <div className="space-y-1">
                                    <p><span className="text-blue-400">POST</span> /api/login</p>
                                    <p><span className="text-blue-400">POST</span> /api/upload (Multipart)</p>
                                    <p><span className="text-green-400">GET</span> /api/items</p>
                                    <p><span className="text-red-400">DEL</span> /api/items/:id</p>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: DATA FEED */}
                        <div className="lg:col-span-2">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">Database Records</h3>
                                    <button onClick={fetchItems} className="text-brand-600 hover:text-brand-800 text-sm">
                                        <i className="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>

                                {loading ? (
                                    <div className="p-12 text-center text-gray-400"><Spinner/> Loading data from secure store...</div>
                                ) : (
                                    <div className="divide-y divide-gray-100">
                                        {items.length === 0 && (
                                            <div className="p-8 text-center text-gray-400">
                                                No records found in database.
                                            </div>
                                        )}
                                        {items.map(item => (
                                            <div key={item.id} className="p-6 hover:bg-blue-50 transition group">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center space-x-3">
                                                        <div className="bg-brand-100 text-brand-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">
                                                            {item.author[0].toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <h4 className="font-bold text-gray-800">{item.title}</h4>
                                                            <p className="text-xs text-gray-500">
                                                                by {item.author} • {new Date(item.createdAt).toLocaleDateString()}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Access Control: Admin OR Owner */}
                                                    {(user.role === 'admin' || user.id === item.userId) && (
                                                        <button 
                                                            onClick={() => handleDelete(item.id)}
                                                            className="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100"
                                                            title="Delete Record"
                                                        >
                                                            <i className="fas fa-trash-alt"></i>
                                                        </button>
                                                    )}
                                                </div>

                                                {/* MEDIA RENDERER */}
                                                {item.url && (
                                                    <div className="mt-3 rounded-lg overflow-hidden border border-gray-200 bg-black">
                                                        {item.fileType === 'video' ? (
                                                            <video src={item.url} controls className="w-full max-h-96 object-contain"></video>
                                                        ) : (
                                                            <img src={item.url} alt="content" className="w-full max-h-96 object-contain" />
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = () => {
            const { login } = useContext(AuthContext);
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('admin@admin.com');
            const [password, setPassword] = useState('admin');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        await login(email, password);
                    } else {
                        await Server.request('POST', '/api/signup', { email, password });
                        setIsLogin(true);
                        Swal.fire('Account Created', 'Please login now.', 'success');
                    }
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-brand-900 to-gray-900 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col">
                        <div className="bg-brand-600 p-6 text-center">
                            <h1 className="text-3xl font-bold text-white tracking-tight">System Login</h1>
                            <p className="text-brand-100 text-sm mt-1">Secure Enterprise Access</p>
                        </div>
                        
                        <div className="p-8">
                            {error && (
                                <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 text-sm mb-6">
                                    {error}
                                </div>
                            )}

                            <form onSubmit={handleAuth} className="space-y-5">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wide">Email</label>
                                    <input 
                                        type="email" 
                                        value={email} 
                                        onChange={e => setEmail(e.target.value)}
                                        className="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wide">Password</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)}
                                        className="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                                        required 
                                    />
                                </div>

                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded transition shadow-lg transform active:scale-95"
                                >
                                    {loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Create Account')}
                                </button>
                            </form>

                            <div className="mt-6 text-center">
                                <button 
                                    onClick={() => setIsLogin(!isLogin)} 
                                    className="text-sm text-brand-600 hover:underline"
                                >
                                    {isLogin ? "New user? Create Account" : "Back to Login"}
                                </button>
                            </div>

                            {isLogin && (
                                <div className="mt-6 pt-6 border-t border-gray-100 text-center">
                                    <p className="text-xs text-gray-400 mb-2">Default Admin Credentials:</p>
                                    <code className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">admin@admin.com / admin</code>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Entry ---
        const App = () => {
            const { user } = useContext(AuthContext);
            return user ? <Dashboard /> : <AuthScreen />;
        };

        const Root = () => (
            <AuthProvider>
                <App />
            </AuthProvider>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
